<!DOCTYPE html>
<html>
<head>
  <title>Google</title>
  <link href="./index.css" rel="stylesheet" />
  <link rel="icon" href="assets/favicon.ico">
  <link rel="apple-touch-icon" href="assets/icon.png">
  <script src="https://kit.fontawesome.com/fe8f095141.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=search" />
</head>
<body>


<div class="ue">
    <a href="https://pontube.onrender.com/home">
      <h1 class="home">Pontube</h1>
    </a>
  <div id="js-result">
<div class="kensaku">
          <input type="url" id="youtube-url" placeholder="検索" class="kensaku1">

 <button type="submit" onclick="e()" class="kensaku2"><span class="material-symbols-outlined">
search
</span></button>

    </div></div>
</div>
  <div id="video-container"></div>
  <div id="video-name"><h1></h1></div>
  <div id="video-link"><h2></h2></div>
   <div id="video-info"><h2></h2></div>
   <div class="iroiro">
<div id="channel-info"></div>
</div>
<div class="iroiroo">
  <div id="syor">
    <div id="description"><p></p></div>
      <div class="kag"></div></div>
        <button type="submit" onclick="sw()" id="syouryaku">もっと見る</button>
  </div>
  <div id="komee">コメント</div>
<div id="komento"></div>
</div>
 <script src="https://iwb.jp/s/js/tiny-console.js"></script>
<script type="module">

  var ifd = 0;
  let d


import { geturl } from "./assets/geturl.js";

const server = await geturl() + "/";
  
  const baseUri = server + "api/v1/videos/";
  console.log(baseUri)
  const getc = "https://script.google.com/macros/s/AKfycbww6z3czhraDQl-_9_UeaaIAvgO7EQ-DpAs9zxiTJJ2uKMbhDSA3hEHAR-mfd76pY0S/exec?id=";
  const getsc = "https://script.google.com/macros/s/AKfycbxAQddNFMquRs13y_2APY7IyA7Ut8m-1KPoB4lUBa-bo9ohn8lSnGN6MNdmUHmQTzKh/exec?id=";
  const come = server + "api/v1/comments/";
console.log("スクリプトを読み込みました")
  const videoId = window.location.hash.slice(1);
  if(videoId){
   const url = document.getElementById('youtube-url');
url.textContent = `http://youtu.be/${videoId}`;
 console.log(videoId)
    loadVideo(videoId);
    loadVideoInfo(videoId);
    //loadComments(videoId);
    
  }
function e() {
  const url = document.getElementById('youtube-url').value;
  const videoId = extractVideoId(url);
  if (videoId) {
    const location = window.location.hash.slice(0);
    window.location.href=`https://hiracmc.github.io/fakeapp/#${videoId}`;

  } else {
    const url = document.getElementById('youtube-url').value;
  const videoId = extractVideoId2(url);
    if(videoId){
    const location = window.location.hash.slice(0);
    window.location.href=`https://hiracmc.github.io/fakeapp/#${videoId}`;

    } else {
    window.location.reload;
  }}
}
  
function sw(){
if(ifd === 1){
  const text = d;
  document.getElementById('description').innerHTML = syoi(text) + ` .....`;
  const button = document.getElementById('syouryaku')
  button.innerText = "もっと見る";
  ifd = 0;
} else {
document.getElementById('description').innerHTML = d;
const button = document.getElementById('syouryaku')
  button.innerText = "一部を表示";
  ifd = 1;
}
}

function syoi(text) {
    const se = /<\/?br\s*\/?>/i;
  const lines = text.split("\n");
  const result = lines.slice(0, 5);
  const kekka = result.join('<br>');
  return kekka;
}


function extractVideoId(url) {
  const regExp = /^.*((youtu.be\/)|(v\/)|(\/?\w?\/))([\w\-]{11}).*/;
  const match = url.match(regExp);
  return (match && match[5].length === 11) ? match[5] : null;
}

  function extractVideoId2(url) {
   const regex = /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/;
  
  const match = url.match(regex);

    if (match) {
    return match[1];
  } else {
    return null;
  }
}

function loadVideo(videoId) {
  const container = document.getElementById('video-container');
  const yoko = (window.innerWidth) * 0.6 + 48;
  const tate = yoko * 9 / 16;

  container.innerHTML = `<iframe width="${yoko}" height="${tate}" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="douga"></iframe>`;

}

function syouryaku(text,max) {
  const maxLength = max;
  if (text.length <= maxLength) {
    return text;
  }
  return text.slice(0, maxLength) + "...";
}

async function loadVideoInfo(videoId) {
  const apiUrl = `${baseUri}${videoId}?hl=ja`;
  try {
    const response = await fetch(apiUrl, {
  headers: {
    "Accept-Language": "ja"
  }
})

    if (!response.ok) {
      throw new Error('APIエラー');
    }
console.log(`動画の説明を読み込みます…${videoId}`)
    const data = await response.json();

    const {
      title,
      viewCount,
      publishedText,
      descriptionHtml
    } = data;


    const descriptionHtmls = "<div class=view>" + fn(viewCount) + ` 回視聴   ` + publishedText + `に投稿済み</div> <div style="white-space: pre-wrap;">` + descriptionHtml + "</div>"
    d = descriptionHtmls;
    document.getElementById('description').innerHTML = descriptionHtmls;
    document.getElementById('video-name').textContent = title;
    document.getElementById('channel-info').textContent = `${data.channelTitle}`;
    const videoinfo = data.author;
      const touroku = data.subCountText;

      const c = `<img src="${data.authorThumbnails[2].url}" alt="ちゃんねる" class="home"> <div class="so"><h3>${syouryaku(videoinfo,25)}</h3><p>${touroku} 人の登録者</p></div>`;

      document.getElementById('channel-info').innerHTML = c;

const text = d;
  document.getElementById('description').innerHTML = syoi(text) + ` .....`;
  const button = document.getElementById('syouryaku')
  button.innerText = "もっと見る";



    getkome(videoId)
  } catch (err) {
    console.error("エラーが発生しました:", err);
  }

  return true;
}

 /**
   * 
   * @param {Array} comments
   */

async function getkome(videoId) {
  const apiUrl = `${come}${videoId}`;
  try {
    const response = await fetch(apiUrl);
    if (!response.ok) {
      throw new Error('APIエラー');
    }

    const data = await response.json();
    console.log(data)
    let text = "";

    data.comments.forEach(comment => {
      const snippet = comment;
      const commentt = snippet.contentHtml;
      const name = comment.author
      const icon = comment.authorThumbnails[0].url
      const commentCount = data.commentCount.toLocaleString();;
      document.getElementById('komee').innerHTML = commentCount + " 件のコメント";
      text += `
        <div class="kome">
          <div class="komeue">
          <img src="${icon}" alt="${name}" width="40" height="40">
          </div>
          <div class="komesita"><p class="b">${name}</p><p class="kometext"><p>${commentt}</p></div>
        </div>
      `;
    })

    document.getElementById('komento').innerHTML = text;

  } catch (err) {
    console.error("エラーが発生しました:", err);
  }
}



function fn(number) {
  if (number >= 100000000) {
        const oku = Math.floor(number / 100000000);
        const man = Math.floor((number % 100000000) / 10000);
        return man > 0 ? `${oku}億${man}万` : `${oku}億`;
    }
    if (number >= 10000) {
        return `${Math.floor(number / 10000)}万`;
    }
    return number.toLocaleString();
}
</script>
</body>
</html>
