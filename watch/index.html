<!DOCTYPE html>
<html>
<head>
  <title>Google</title>
  <link href="./index.css" rel="stylesheet" />
  <link rel="icon" href="assets/favicon.ico">
  <link rel="apple-touch-icon" href="assets/icon.png">
  <script src="https://kit.fontawesome.com/fe8f095141.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
</head>
<body>
<script>
  const ip = window.location.origin;
  let ifd = 0;
  let d

  function rirekiset(newrireki) {
    console.log(newrireki)
    const key = 'rireki';
    const max = 150;
    if (!newrireki || typeof newrireki.id === "undefined") return;

    try {
      const Data = localStorage.getItem(key)
      let dataArray = [];
      if (Data) {
  try {
  const parsedData = JSON.parse(Data);
  if (Array.isArray(parsedData)) {
  dataArray = parsedData;
  }
  } catch (e) {
  console.error('Fail', e);
  }
  }

  let updatedArray = dataArray.filter(item => item.id !== rirekiItem.id);
  updatedArray.unshift(newrireki);

  if (updatedArray.length > max) {
  updatedArray = updatedArray.slice(0, max);
  }
  console.log(`a ${updatedArray}`)
  localStorage.setItem(key, JSON.stringify(updatedArray));

  return updatedArray;

  } catch (e) {
  return;
    }
  }


  function sw(){
if(ifd === 1){
  const text = d;
  document.getElementById('description').innerHTML = syoi(text) + ` .....`;
  const button = document.getElementById('syouryaku')
  button.innerText = "もっと見る";
  ifd = 0;
} else {
document.getElementById('description').innerHTML = d;
const button = document.getElementById('syouryaku')
  button.innerText = "一部を表示";
  ifd = 1;
}
}
  function syoi(text) {
    const se = /<\/?br\s*\/?>/i;
  const lines = text.split("\n");
  const result = lines.slice(0, 5);
  const kekka = result.join('<br>');
  return kekka;
  }
function e() {
  event.preventDefault()
  const url = document.getElementById('youtube-url').value;
  if (url){
  const videoId = extractVideoId(url);
  if (videoId) {
    const location = window.location.hash.slice(0);
    window.location.href=`${ip}/watch/?v=${videoId}`;

  } else {
    const url = document.getElementById('youtube-url').value;
  const videoId = extractVideoId2(url);
    if(videoId){
    const location = window.location.hash.slice(0);
    window.location.href=`${ip}/watch/?v=${videoId}`;

    } else {
    window.location.href=`${ip}/search/?q=${url}`;
  }}
}}

function extractVideoId(url) {
  const regExp = /^.*((youtu.be\/)|(v\/)|(\/?\w?\/))([\w\-]{11}).*/;
  const match = url.match(regExp);
  return (match && match[5].length === 11) ? match[5] : null;
}

  function extractVideoId2(url) {
   const regex = /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/;
  
  const match = url.match(regex);

    if (match) {
    return match[1];
  } else {
    return null;
  }
}
  </script>

<div class="ue">
    <div id="gohome"></div>

    <form class="kensaku">

          <input type="text" id="youtube-url" placeholder="検索" class="kensaku1">

 <button type="submit" onclick="e()" class="kensaku2"><img src="https://hiracmc.github.io/psvg/svg/psvg_search.svg" width="20px" height="20px"></button>
</form>

    </div>
</div>
  <div id="sippa"><h1></h1></div>
  <div id="video-container"></div>
  <div id="video-name"><h1>読み込み中</h1></div>
  <div id="video-link"><h2></h2></div>
   <div id="video-info"><h2></h2></div>
   <div class="iroiro">
<div id="channel-info"></div>
</div>
<div class="iroiroo">
  <div id="syor">
    <div id="description"><p>読み込み中...</p></div>
      <div class="kag"></div></div>
        <button type="submit" onclick="sw()" id="syouryaku">もっと見る</button>
  </div>
  <div id="komee">読み込み中...</div>
<div id="komento"></div>

<!--<script src="https://iwb.jp/s/js/tiny-console.js"></script>-->
<script type="module">
async function getData(add) {
   let link = [
  "https://iv.melmac.space",
  "https://invidious.reallyaweso.me",
  "https://invidious.adminforge.de",
  "https://invidious.esmailelbob.xyz",
  "https://invidious.nerdvpn.de",
  "https://invidious.perennialte.ch",
  "https://invidious.dhusch.de",
  "https://invidious.0011.lt",
  "https://invidious.materialio.us",
  "https://usa-proxy2.poketube.fun",
  "https://invidious.darkness.service",
  "https://invidious.flokinet.to",
  "https://invidious.fdn.fr",
  "https://iv.duti.dev",
  "https://yt.artemislena.eu",
  "https://invidious.projectsegfau.lt",
  "https://id.420129.xyz",
  "https://invidious.jing.rocks",
  "https://nyc1.iv.ggtyler.dev",
  "https://inv.in.projectsegfau.lt",
  "https://invidious.drgns.space",
  "https://cal1.iv.ggtyler.dev",
  "https://invidious.nikkosphere.com",
  "https://inv.us.projectsegfau.lt",
  "https://lekker.gay",
  "https://youtube.mosesmang.com",
  "https://invidious.privacyredirect.com",
  "https://invidious.lunivers.trade",
  "https://invidious.incogniweb.net",
  "https://invid-api.poketube.fun",
  "https://inv.tux.pizza",
  "https://invidious.ducks.party",
  "https://pol1.iv.ggtyler.dev",
  "https://invidious.protokolla.fi",
  "https://invidious.einfachzocken.eu",
  "https://yewtu.be",
  "https://iv.datura.network",
  "https://invidious.f5.si",
  "https://invidious.privacydev.net",
  "https://eu-proxy.poketube.fun",
  "https://yt.drgnz.club",
  "https://inv.nadeko.net",
  "https://invidious.private.coffee"
];


  const li = `/api/v1/${add}`;
  const controller = new AbortController();
  const signal = controller.signal;

  const promises = link.map(async urll => {
    const url = urll + li;
    
    try {
      const response = await fetch(url, { signal });
      
      if (response.ok) {
        console.log(`このインスタンスのデータを使用します ${url}`);
        const data = await response.json();
        controller.abort();
        return { from: urll, data: data };
      } else {
        throw new Error(`接続に失敗 ${response.status}  ${url}`);
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        throw error;
      }
      throw new Error(`接続エラー: ${error.message}`);
    }
  });

  try {
    const result = await Promise.any(promises);
    return result.data;
  } catch (error) {
    console.error("\nすべてのサーバーへの接続に失敗しました。");
    document.getElementById('sippa').innerHTML = `<h1 style="color : #fff;font-size:16px; margin-left: 40px;">動画の情報の読み込みに失敗しました。再読み込みボタンをしてもう一度試してください</h1>`;
    return null;
  }
}


const server = "https://invidious.nikkosphere.com";
  const baseUri = server + "/api/v1/videos/";
  console.log(baseUri)
  const come = server + "/api/v1/comments/";
console.log("スクリプトを読み込みました")
  const url = new URL(window.location.href);
  const ne =  url.searchParams.get('v');
  console.log(ne)
  const videoId = ne;
  if(videoId){
   const url = document.getElementById('youtube-url');
url.textContent = `http://youtu.be/${videoId}`;
 console.log(videoId)
    rirekiset(videoId)
    loadVideoInfo(videoId);
  }

function syouryaku(text,max) {
  const maxLength = max;
  if (text.length <= maxLength) {
    return text;
  }
  return text.slice(0, maxLength) + "...";
}

async function loadVideoInfo(videoId) {
  const apiUrl = `${baseUri}${videoId}`;
  try {
    const response = getData(`videos/${videoId}`)
console.log(`動画の説明を読み込みます…${videoId}`)
    const data = await response;



    const container = document.getElementById('video-container');
  const yoko = (window.innerWidth) * 0.6 + 48;
  const tate = yoko * 9 / 16;
  if (localStorage.getItem('if_eme') === "true"){
  container.innerHTML = `<iframe width="${yoko}" height="${tate}" src="https://www.youtube-nocookie.com/embed/${videoId}?loop=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="douga"></iframe>`;
  } else {
    const omg = await data.formatStreams?.map(stream => stream.url) || [];
    console.log(`${omg}`)
    let loop = ""
    if(localStorage.getItem('if_loop') === "true"){
      loop = "loop"
    }
    container.innerHTML = `<video src="${omg}" width="${yoko}" height="${tate}" ${loop} poster="${data.videoThumbnails[3].url}" controls>動画の読み込みに失敗しました</video>`;
  }



    const {
      title,
      viewCount,
      publishedText,
      descriptionHtml
    } = data;


    const descriptionHtmls = "<div class=view>" + fn(viewCount) + ` 回視聴   ` + publishedText + `に投稿済み</div> <div style="white-space: pre-wrap;">` + descriptionHtml + "</div>"
    d = descriptionHtmls;
    document.getElementById('description').innerHTML = descriptionHtmls;
    document.getElementById('video-name').textContent = title;
    document.getElementById('channel-info').textContent = `${data.channelTitle}`;
    const videoinfo = data.author;
      const touroku = data.subCountText;

      const c = `<a style="text-decoration: none;" href="${ip}/channel/?c=${data.authorId}"><img src="${data.authorThumbnails[2].url}" alt="ちゃんねる" class="home"> <div class="so"><h3>${syouryaku(videoinfo,25)}</h3></a><p>${touroku} 人の登録者</p></div>`;

      document.getElementById('channel-info').innerHTML = c;

const text = d;
  document.getElementById('description').innerHTML = syoi(text) + ` .....`;
  const button = document.getElementById('syouryaku')
  button.innerText = "もっと見る";

    getkome(videoId)
  } catch (err) {
    console.error("エラーが発生しました:", err);
  }

  return true;
}

 /**
   * 
   * @param {Array} comments
   */

async function getkome(videoId) {
  const apiUrl = `${come}${videoId}`;
  try {
    const response = await getData(`comments/${videoId}`)
    console.log(response)
console.log(`動画の説明を読み込みます…${videoId}`)
    const data = await response;
    console.log(data)
    let text = "";

    data.comments.forEach(comment => {
      const snippet = comment;
      const commentt = snippet.contentHtml;
      const name = comment.author
      const icon = comment.authorThumbnails[0].url
      const commentCount = data.commentCount.toLocaleString();;
      document.getElementById('komee').innerHTML = commentCount + " 件のコメント";
      text += `
        <div class="kome">
          <div class="komeue">
            <a href="${ip}/channel/?c=${comment.authorId}">
          <img src="${icon}" alt="${name}" width="40" height="40">
          </a>
          </div>
          <div class="komesita"><a href="${ip}/channel/?c=${comment.authorId}"><p class="b">${name}</p></a><p class="kometext"><p>${commentt}</p></div>
        </div>
      `;
    })

    document.getElementById('komento').innerHTML = text;

  } catch (err) {
    console.error("エラーが発生しました:", err);
  }
}



function fn(number) {
  if (number >= 100000000) {
        const oku = Math.floor(number / 100000000);
        const man = Math.floor((number % 100000000) / 10000);
        return man > 0 ? `${oku}億${man}万` : `${oku}億`;
    }
    if (number >= 10000) {
        return `${Math.floor(number / 10000)}万`;
    }
    return number.toLocaleString();
}

document.getElementById('gohome').innerHTML = `<a href="${ip}/home"><h1 class="home">Pontube</h1></a>`;
</script>
</body>
</html>
