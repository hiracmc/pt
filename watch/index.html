<!DOCTYPE html>
<html>
<head>
  <title>Google</title>
  <link href="./index.css" rel="stylesheet" />
  <link rel="icon" href="assets/favicon.ico">
  <link rel="apple-touch-icon" href="assets/icon.png">
  <script src="https://kit.fontawesome.com/fe8f095141.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=thumb_up" />

</head>
<body>
<script>
  const ip = window.location.origin;
  let ifd = 0;
  let d





  function sw(){
if(ifd === 1){
  const text = d;
  document.getElementById('description').innerHTML = syoi(text) + ` .....`;
  const button = document.getElementById('syouryaku')
  button.innerText = "もっと見る";
  ifd = 0;
} else {
document.getElementById('description').innerHTML = d;
const button = document.getElementById('syouryaku')
  button.innerText = "一部を表示";
  ifd = 1;
}
}
  function syoi(text) {
    const se = /<\/?br\s*\/?>/i;
  const lines = text.split("\n");
  const result = lines.slice(0, 5);
  const kekka = result.join('<br>');
  return kekka;
  }
function e() {
  event.preventDefault()
  const url = document.getElementById('youtube-url').value;
  if (url){
  const videoId = extractVideoId(url);
  if (videoId) {
    const location = window.location.hash.slice(0);
    window.location.href=`${ip}/watch/?v=${videoId}`;

  } else {
    const url = document.getElementById('youtube-url').value;
  const videoId = extractVideoId2(url);
    if(videoId){
    const location = window.location.hash.slice(0);
    window.location.href=`${ip}/watch/?v=${videoId}`;

    } else {
    window.location.href=`${ip}/search/?q=${url}`;
  }}
}}

function extractVideoId(url) {
  const regExp = /^.*((youtu.be\/)|(v\/)|(\/?\w?\/))([\w\-]{11}).*/;
  const match = url.match(regExp);
  return (match && match[5].length === 11) ? match[5] : null;
}

  function extractVideoId2(url) {
   const regex = /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/;
  
  const match = url.match(regex);

    if (match) {
    return match[1];
  } else {
    return null;
  }
}
  </script>

<div class="ue">
    <div id="gohome"></div>

    <form class="kensaku">

          <input type="text" id="youtube-url" placeholder="検索" class="kensaku1">

 <button type="submit" onclick="e()" class="kensaku2"><img src="https://hiracmc.github.io/psvg/svg/psvg_search.svg" width="20px" height="20px"></button>
</form>

    </div>
</div>
  <div id="sippa"><h1></h1></div>
  <div id="view"><div id="view2">
  <div id="video-container"></div>
  <div id="video-name"><h1>読み込み中</h1></div>
  <div id="video-link"><h2></h2></div>
   <div id="video-info"><h2></h2></div>
   <div class="iroiro">
<div id="channel-info"></div>
</div>
<div class="iroiroo">
  <div id="syor">
    <div id="description"><p>読み込み中...</p></div>
      <div class="kag"></div></div>
        <button type="submit" onclick="sw()" id="syouryaku">もっと見る</button>
  </div>
  
  <div id="komee">読み込み中...</div>
<div id="komento"></div>
</div>
<div class="blockin">
<div id="kanrendayo">関連動画</div>
<div id="osusume"></div></div>
</div>
<script type="module" src="../api/v1.js"></script>
<!--<script src="https://iwb.jp/s/js/tiny-console.js"></script>-->
<script type="module">

import {getData} from '../api/v1.js';
const server = "https://invidious.nikkosphere.com";
  const baseUri = server + "/api/v1/videos/";
  console.log(baseUri)
  const come = server + "/api/v1/comments/";
console.log("スクリプトを読み込みました")
  const url = new URL(window.location.href);
  const ne =  url.searchParams.get('v');
  const t =  url.searchParams.get('t');
  console.log(ne)
  const videoId = ne;
  if(videoId){
   const url = document.getElementById('youtube-url');
url.textContent = `http://youtu.be/${videoId}`;
 console.log(videoId)
    loadVideoInfo(videoId);
  }


function timest(text, urlTemplate) {
  const timeRegex = /\b(\d{1,2}):([0-5]\d)\b/g;

  return text.replace(timeRegex, (match, minutes, seconds) => {
    const minInt = parseInt(minutes, 10);
    const secInt = parseInt(seconds, 10);
    const totalSeconds = (minInt * 60) + secInt;

    const linkUrl = urlTemplate.replace('{SECONDS}', totalSeconds);
    return `<a href="${linkUrl}" class="timestamp-link" data-seconds="${totalSeconds}">${match}</a>`;
  });
}

  /**
 * @param {number} totalSeconds
 * @returns {string}
 */
function time(totalSeconds) {
  if (typeof totalSeconds !== 'number' || totalSeconds < 0) {
    return "0";
  }
  if (totalSeconds === 0) {
    return "0";
  }

  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  const parts = [];
  if (hours > 0) {
    parts.push(`${hours}:`);
  }
    parts.push(`${String(minutes).padStart(2, '0')}:`);
    parts.push(`${String(seconds).padStart(2, '0')}`);

  return parts.join('');
}

  function samun(str,getip) {
    if(str[0] === "/"){
      if(str[1] === "/"){
      return "https:" + str }else {
        return `${getip}${str}`
      }
    } else {return str}
  }

function syouryaku(text,max) {
  const maxLength = max;
  if (text.length <= maxLength) {
    return text;
  }
  return text.slice(0, maxLength) + "...";
}

function km(input){const cleanInput=input.trim().toLowerCase();const lastChar=cleanInput.slice(-1);const numberPart=parseFloat(cleanInput.slice(0, -1));let multiplier=1;switch (lastChar){case'k':multiplier=1000;break;case 'm':multiplier = 1000000;break;case'b':multiplier=1000000000;break;default:const fullNumber=parseFloat(cleanInput);return isNaN(fullNumber)?input:fullNumber;}return numberPart*multiplier;}

async function loadVideoInfo(videoId) {
  const apiUrl = `${baseUri}${videoId}`;
  try {
    const response = await getData(`videos/${videoId}`)
console.log(`動画の説明を読み込みます…${videoId}`)
    const data = await response.data;



    const container = document.getElementById('video-container');
  const yoko = (window.innerWidth) * 0.6 + 48;
  const tate = yoko * 9 / 16;
  if (localStorage.getItem('if_eme') === "true"){
    let ta = ""
    if (t){
      ta = "start=" + t
    }
  container.innerHTML = `<iframe width="${yoko}" height="${tate}" src="https://www.youtube-nocookie.com/embed/${videoId}?loop=1${ta}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="douga"></iframe>`;
  } else {
    const omg = await data.formatStreams?.map(stream => stream.url) || [];
    console.log(`${omg}`)
    let loop = ""
    if(localStorage.getItem('if_loop') === "true"){
      loop = "loop"
    }
    container.innerHTML = `<video id="vide" src="${omg}" width="${yoko}" height="${tate}" ${loop} poster="${samun(data.videoThumbnails[3].url)}" controls>動画の読み込みに失敗しました</video>`;
    document.getElementById('vide').volume = 0.03

  }
  



    const {
      title,
      viewCount,
      publishedText,
      descriptionHtml
    } = data;


    const descriptionHtmls = "<div class=view>" + fn(viewCount) + ` 回視聴   ` + publishedText + `に投稿済み</div> <div style="white-space: pre-wrap;">` + descriptionHtml + "</div>"
    d = descriptionHtmls;
    document.getElementById('description').innerHTML = descriptionHtmls;
    document.getElementById('video-name').textContent = title;
    document.getElementById('channel-info').textContent = `${data.channelTitle}`;
    const videoinfo = data.author;
      const touroku = data.subCountText;

      const c = `<a style="text-decoration: none;" href="${ip}/channel/?c=${data.authorId}"><img src="${data.authorThumbnails[2].url}" alt="ちゃんねる" class="home"> <div class="so"><h3>${syouryaku(videoinfo,25)}</h3></a><p>${fn(km(touroku))}人の登録者</p></div>`;

      document.getElementById('channel-info').innerHTML = c;

const text = d;
  document.getElementById('description').innerHTML = syoi(text) + ` .....`;
  const button = document.getElementById('syouryaku')
  button.innerText = "もっと見る";
    getkome(videoId)

const vieww = document.documentElement.clientWidth / 98;


    const osusume = document.getElementById('osusume');
    const osusu = await data.recommendedVideos
let ht = ""
console.log(osusu)
let index = 0;
for (const d of osusu){
  index ++;
  const samuine = samun(d.videoThumbnails[3].url,response.by)
  const times = time(d.lengthSeconds);
  const sya = syouryaku(d.author,vieww)
let zika = `<p class=dougazikan>${times}</p>`;
ht += `
<div class="kanrendouga">
<div class="dougasamune">
            <a href="${ip}/watch/?v=${d.videoId}">
          <img src="${samuine}" alt="${d.title}" width="160" height="110">
          ${zika}
          </a>
          
          </div>
          <div class="blo">
          <a href="${ip}/watch/?v=${d.videoId}">
            <p class="kanrentitle">${syouryaku(d.title,vieww + 6)}</p>
            </a>
            
          <div class="sya"><a href="${ip}/channel/?c=${d.authorId}"><p class="b">${sya}</p></a></div><p class="c">${d.publishedText}に投稿</p></div>
            </div>
            </div>
`
}
osusume.innerHTML = ht;




  } catch (err) {
    console.error("エラーが発生しました:", err);
  }

  return true;
}


function setTime(s) {
  const scroll = localStorage.getItem('if_scroll');
  if (scroll === "true"){
    window.scrollTo({
  top: 0,
  behavior: 'smooth'
});
  }
  document.getElementById('vide').currentTime = s
}

async function getkome(videoId) {
  const apiUrl = `${come}${videoId}`;
  try {
    const response = await getData(`comments/${videoId}`)
    console.log(response)
console.log(`動画の説明を読み込みます…${videoId}`)
    const data = await response.data;
    console.log(data)
    let text = "";

    data.comments.forEach(comment => {
      const snippet = comment;
      const commentt = timest(snippet.content,`${ip}/watch/?v=${videoId}&t={SECONDS}s`);
      const name = comment.author
      const icon = comment.authorThumbnails[0].url
      const commentCount = data.commentCount.toLocaleString();;
      document.getElementById('komee').innerHTML = commentCount + " 件のコメント";
      text += `
        <div class="kome">
          <div class="komeue">
            <a href="${ip}/channel/?c=${comment.authorId}">
          <img src="${icon}" alt="${name}" width="40" height="40">
          </a>
          </div>
          <div class="komesita"><a href="${ip}/channel/?c=${comment.authorId}"><p class="b">${name}</p></a><p class="kometext"><p>${commentt}</p></div>

        </div>
      `;
    })
    const kom = document.getElementById('komento');
    kom.innerHTML = text;


    kom.addEventListener('click', function(event) {

  const link = event.target.closest('a.timestamp-link');

  if (!link) {
    return;
  }
  event.preventDefault();
  const seconds = parseInt(link.dataset.seconds, 10);
  setTime(seconds);
});

  } catch (err) {
    console.error("エラーが発生しました:", err);
  }
}



function fn(number) {
  if (number >= 100000000) {
        const oku = Math.floor(number / 100000000);
        const man = Math.floor((number % 100000000) / 10000);
        return man > 0 ? `${oku}億${man}万` : `${oku}億`;
    }
    if (number >= 10000) {
        return `${Math.floor(number / 10000)}万`;
    }
    return number.toLocaleString();
}

document.getElementById('gohome').innerHTML = `<a href="${ip}/home"><h1 class="home">Pontube</h1></a>`;
</script>
</body>
</html>
